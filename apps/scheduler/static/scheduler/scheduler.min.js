function init_fc_extras(sel,view){let calendar=$(sel);if(view.name==="yearshift"){calendar.find(".fc-nextYear-button, .fc-prevYear-button").removeClass("hidden")}else{calendar.find(".fc-prev-button, .fc-next-button").removeClass("hidden");calendar.find(".fc-nextYear-button, .fc-prevYear-button").addClass("hidden")}$(".fc-clear").remove();$(".fc-toolbar .fc-button-group").addClass("btn-group");$(".fc-button").addClass("btn border")}let FC=$.fullCalendar;let View=FC.BasicView;let yearShiftView,monthShiftView,cycleShiftView;yearShiftView=View.extend({duration:{months:12},templateUrl:"",render:function(){let date=this.calendar.getDate();let params=`?date=${date.format("YYYY-MM-DD")}`;this.url=this.opt("templateUrl")+params;this.updateTitle(date.year())},renderSkeletonHtml:function(){return""}});monthShiftView=View.extend({templateUrl:"",sectionHeaders:"",duration:{months:1},renderSkeletonHtml:function(){return""},render:function(){let date=this.calendar.getDate();let params=`?date=${date.format("YYYY-MM-DD")}`;if(this.opt("sectionHeaders")){params+=`&sections=${this.opt("sectionHeaders")}`}if(this.opt("rangeStart")){params+=`&start=${this.opt("rangeStart")}`}if(this.opt("rangeEnd")){params+=`&end=${this.opt("rangeEnd")}`}this.url=this.opt("templateUrl")+params;this.updateTitle(date.format("MMMM, YYYY"))}});cycleShiftView=View.extend({templateUrl:"",sectionHeaders:"",duration:{months:6},titleFormat:"YYYY",render:function(){let date=this.calendar.getDate();let params=`?date=${date.format("YYYY-MM-DD")}`;if(this.opt("rangeStart")){params+=`&start=${this.opt("rangeStart")}`}if(this.opt("rangeEnd")){params+=`&end=${this.opt("rangeEnd")}`}this.url=this.opt("templateUrl")+params;this.intervalDuration=moment.duration({months:6})},renderSkeletonHtml:function(){return""},computeRange:function(date){let cur_date=moment({year:date.year(),month:date.month()<6?0:6,date:1});return View.prototype.computeRange.call(this,cur_date)},computeTitle:function(){return this.intervalStart.format("YYYY")}});FC.views.yearshift=yearShiftView;FC.views.monthshift=monthShiftView;FC.views.cycleshift=cycleShiftView;function updateStats(url){if(url){$.ajax({type:"GET",url:url,success:function(data){$(".stats").html("");$.each(data,function(i,item){$("#stats-"+item.id).html(item.count)})}})}}function setupAjax(csrf_token){$.ajaxSetup({beforeSend:function(xhr,settings){if(!/^(GET|HEAD|OPTIONS|TRACE)$/.test(settings.type)&&!this.crossDomain){xhr.setRequestHeader("X-CSRFToken",csrf_token)}},error:function(jqXHR,textStatus,errorThrown){dfToasts.error({message:`Operation Failed: ${errorThrown}`})},async:true,contentType:"application/json; charset=utf-8"})}function setupCalendar(sel,options){let defaults={editorType:"event",editor:false,showLinks:true,rangeStart:"",rangeEnd:"",viewChoices:""};options=$.extend({},defaults,options||{});$(sel).fullCalendar({header:{left:"title",center:options.viewChoices,right:"prevYear,prev,next,nextYear,today"},buttonText:{today:"Today",monthshift:"Month",yearshift:"Year",weekshift:"Week",cycleshift:"Cycle"},allDaySlot:false,contentHeight:"auto",defaultDate:options.defaultDate,timezone:options.timezone,defaultView:options.defaultView,slotEventOverlap:false,allDay:false,eventSources:options.eventSources,views:{monthshift:{duration:{months:1},templateUrl:options.monthTemplateUrl,rangeStart:options.rangeStart,rangeEnd:options.rangeEnd},cycleshift:{titleFormat:"YYYY",duration:{months:6},templateUrl:options.cycleTemplateUrl},yearshift:{duration:{months:12},templateUrl:options.yearTemplateUrl},weekshift:{type:"monthshift",unit:"week",duration:{days:7},templateUrl:options.weekTemplateUrl,sectionHeaders:options.weekSectionHeaders}},viewRender:function(view,element){init_fc_extras(sel,view);view.el.load(view.url,function(){$(sel).fullCalendar("refetchEvents")})},eventRender:function(event,element,view){let duration=moment.duration({hours:options.shiftDuration});let cur_shift=event.start.clone();let section_prefix="";let shift,shift_sel;if(view.name==="weekshift"&&event.section){section_prefix=`.cal-section-${event.section} > `}let first_shift=$(`.shift-${cur_shift.tz(options.timezone).format("YYYY-MM-DD[T]HH")}`);while(cur_shift<event.end){shift_sel=`.shift-${cur_shift.tz(options.timezone).format("YYYY-MM-DD[T]HH")}`;cur_shift.add(duration);shift=$(section_prefix+shift_sel);if(event.rendering==="mode"){shift.attr("class",`${shift.attr("data-default-class")} mode-${event.kind}`);shift.attr("title",event.description);if(event.tentative)shift.addClass("tentative");if(event.cancelled){shift.addClass("Can");shift.attr("title",`${event.description} [cancelled]`)}if(view.name==="monthshift"&&options.editorType==="mode"){shift.html(`<div class='event-tools'></div><div class='text-condensed mode-label'>${event.display}</div>`);first_shift.find(".event-tools").addClass("active").data("event",event)}}else if(event.rendering==="preferences"){$("#"+event.start.format("YYYY-MM-DD")).addClass(`prefs-${event.type}`)}else if(event.rendering==="beamtime"||event.rendering==="staff"&&(view.name==="weekshift"||options.editor)){let tag_html="";let tag_titles=[];const $tagElement=$(`[data-tag]`);shift.attr("title",event.description);$.each(event.tags,function(i,tag){tag_titles.push($tagElement.data("tag"));tag_html+=`<i class='bi-tag cat-fg-${$tagElement.data("cat")}'></i>`});tag_html=`<span title='${tag_titles.join("; ")}'>${tag_html}</span>`;if(view.name==="monthshift"||view.name==="weekshift"){shift.addClass("fg-"+event.project_type);shift.html(`<div class='event-tools'></div>
                            <div class='text-condensed overflow ellipsis event-label'><span class='hidden-sm'>${event.display}</span>
                            `);if(options.editor){first_shift.find(".event-tools").addClass("active").data("event",event)}if(options.showLinks&&event.url){shift.find(".event-label").attr("data-href",event.url)}}if(event.cancelled){shift.find(".event-label").addClass("cancelled")}}}return false}});$(sel+":not(.starting, .ending)").on("click","[data-event-href]",function(){window.document.location=$(this).attr("data-event-href")})}function eventToolsContent(){let $control=$(this);let event=$control.data("event");let comments=event.comments?event.comments:"";$control.popover({html:true,trigger:"focus",placement:"bottom",container:"body",customClass:"event-tools-popover",sanitize:false,content:function(){return`
                        <textarea class="form-control w-100 mb-2" type="text" rows="3" name="comments" placeholder="Comments ...">${comments}</textarea>
                        <div class='toolbox mt-2'>
                            <a href='#0' data-action='comments'><i class='bi-floppy icon-sm'></i><span class="tool-label">Save</span></a>
                            <a href='#0' data-action='cancel'><i class='bi-ban icon-sm'></i><span class="tool-label">Cancel</span></a>
                            <a href='#0' data-action='reset'><i class='bi-arrow-clockwise icon-sm'></i><span class="tool-label">Reset</span></a>
                            <a href='#0' data-action='delete'><i class='bi-trash icon-sm'></i><span class="tool-label">Delete</span></a>
                        </div>
                    `}})}function setupEditor(sel,options){let defaults={editorType:"event"};options=$.extend({},defaults,options||{});let $calendar=$(sel);$calendar.addClass("idle");function clearEvents(){$(".cal-day .cal-shift").each(function(){const shift=$(this);shift.attr("class",shift.attr("data-default-class"));shift.html("")})}$(document).on("click",".event-src",function(event){$calendar.fullCalendar("removeEventSource",$(".active-src").attr("data-extra-events-url"));const $eventSrc=$(".event-src");$(".fc-day-number.prefs-available, .fc-day-number.prefs-unavailable").removeClass("prefs-available prefs-unavailable");if(!$(this).is(".active-src")){$eventSrc.removeClass("active-src");$(this).addClass("active-src");$calendar.removeClass("idle ending").addClass("starting");$calendar.fullCalendar("addEventSource",$(this).attr("data-extra-events-url"));$.each($(this).data("event").tags,function(i,id){$(`#tag-${id}`).addClass("active")})}else{const class_name=`selected-${$(".event-src.active-src").attr("data-key")}`;$eventSrc.removeClass("active-src");$calendar.removeClass("ending starting").addClass("idle");$(`.cal-shift.${class_name}`).removeClass(class_name);$(".tag").removeClass("active")}});$(document).on("click",".starting .fc-view .cal-day .cal-shift",function(event){$calendar.removeClass("idle starting").addClass("ending").attr("data-range-start",$(this).attr("data-shift-id"))});$(document).on("click",".ending .fc-view .cal-day .cal-shift",function(event){let t1=moment($calendar.attr("data-range-start"),"YYYY-MM-DDTHH");let t2=moment($(this).attr("data-shift-id"),"YYYY-MM-DDTHH");let start_time=moment(moment.min(t1,t2));let end_time=moment(moment.max(t1,t2));end_time.add(moment.duration({hours:options.shiftDuration}));let post_data=$.extend(true,{},$(".event-src.active-src").data("event"));post_data["start"]=start_time.toISOString();post_data["end"]=end_time.toISOString();post_data["tags"]=$(".tag.active").map(function(){return $(this).data("tag")}).get();$.ajax({url:options.eventsAPI,type:"POST",data:JSON.stringify(post_data),success:function(data){clearEvents();const $activeSrc=$(".event-src.active-src");$calendar.fullCalendar("refetchEvents");$calendar.removeClass("idle ending").addClass("starting");$.each($activeSrc.data("event").tags,function(i,id){$(`#tag-${id}`).addClass("active")});updateStats(options.statsAPI)}})});$(document).on("mouseenter",".ending .fc-view .cal-shift",function(event){let selected=[];let t1=moment($calendar.attr("data-range-start"),"YYYY-MM-DDTHH");let t2=moment($(this).attr("data-shift-id"),"YYYY-MM-DDTHH");let class_name="selected-"+$(".event-src.active-src").attr("data-key");let start_time=moment(moment.min(t1,t2));let end_time=moment(moment.max(t1,t2));end_time=end_time.add(moment.duration({hours:options.shiftDuration}));let cur_shift=moment(start_time);while(cur_shift<end_time){selected.push(`.shift-${cur_shift.tz(options.timezone).format("YYYY-MM-DD[T]HH")}`);cur_shift=cur_shift.add(moment.duration({hours:options.shiftDuration}))}$(".cal-shift."+class_name).removeClass(class_name);$(selected.join()).addClass(class_name)});$(document).keyup(function(e){if(e.keyCode===27){$calendar.fullCalendar("removeEventSource",$(".active-src").attr("data-extra-events-url"));let class_name=`selected-${$(".event-src.active-src").attr("data-key")}`;$(".event-src").removeClass("active-src");$calendar.removeClass("ending starting").addClass("idle");$(`.cal-shift.${class_name}`).removeClass(class_name);$(".tag").removeClass("active")}});$(document).on("click",".starting .cal-day-header .cal-shift",function(){let shifts=$(this).closest(".cal-row").find(".shift-"+$(this).attr("data-shift-time"));let post_data=[];shifts.each(function(){let t1=moment($(this).attr("data-shift-id"),"YYYY-MM-DDTHH");let t2=moment(t1);t2.add(moment.duration({hours:options.shiftDuration}));let entry=$.extend(true,{},$(".event-src.active-src").data("event"));entry["start"]=t1.toISOString();entry["end"]=t2.toISOString();entry["tags"]=$(".tag.active").map(function(){return $(this).data("tag")}).get();post_data.push(entry)});$.ajax({url:options.eventsAPI,type:"POST",data:JSON.stringify(post_data),success:function(data){clearEvents();$calendar.fullCalendar("refetchEvents");updateStats(options.statsAPI)}})});$(document).on("click",".idle .cal-shift .event-tools.active",function(){const $control=$(this);let event=$control.data("event");let comments=event.comments?event.comments:"";$control.popover({html:true,trigger:"manual",placement:"bottom",container:"body",customClass:"event-tools-popover",sanitize:false,content:function(){return`
                        <textarea class="form-control w-100 mb-2" type="text" rows="3" name="comments" placeholder="Comments ...">${comments}</textarea>
                        <div class='toolbox mt-2'>
                            <a href='#0' data-action='comments'><i class='bi-floppy icon-sm'></i><span class="tool-label">Save</span></a>
                            <a href='#0' data-action='cancel'><i class='bi-ban icon-sm'></i><span class="tool-label">Cancel</span></a>
                            <a href='#0' data-action='reset'><i class='bi-arrow-clockwise icon-sm'></i><span class="tool-label">Reset</span></a>
                            <a href='#0' data-action='delete'><i class='bi-trash icon-sm'></i><span class="tool-label">Delete</span></a>
                        </div>
                    `}});$control.popover("show");$(document).off("click.event-tools").on("click.event-tools",function(e){if(!$(e.target).closest(".event-tools-popover").length){$control.popover("hide")}});$(".event-tools-popover a[data-action]").off("click.tool-action").on("click.tool-action",function(){const $popover=$(this).closest(".event-tools-popover");let action=$(this).attr("data-action");if(action==="comments"){event["comments"]=$popover.find("textarea").val()}else{event[action]=true}$.ajax({url:options.eventsAPI,type:"post",dataType:"json",contentType:"application/json",data:JSON.stringify(event),success:function(data){clearEvents();$calendar.fullCalendar("refetchEvents");updateStats(options.statsAPI)}});$control.popover("hide")})});$(document).on("mouseenter",".starting .cal-day-header .cal-shift",function(event){let class_name=`selected-${$(".event-src.active-src").attr("data-key")}`;$(".cal-shift."+class_name).removeClass(class_name);$(`.cal-shift.shift-day-${$(this).attr("data-shift-day")}.shift-time-${$(this).attr("data-shift-time")}`).addClass(class_name)});$(document).on("mouseleave",".fc-view",function(event){let class_name=`selected-${$(".event-src.active-src").attr("data-key")}`;$(`.cal-day .cal-shift.${class_name}`).removeClass(class_name)});$(document).on("click",".tag",function(){$(this).toggleClass("active")});updateStats(options.statsAPI)}