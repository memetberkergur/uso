{% extends "page.html" %}
{% load static %}
{% load folio %}
{% load dynforms %}
{% load beamlines %}
{% load samples_tags %}
{% load proposal_tags %}
{% load markup %}


{% block page-pretitle %}
    Proposal
{% endblock %}

{% block page-title %}{{ proposal.code }}{% endblock %}
{% block page-subtitle %}
    Created: {{ proposal.created | date }} &ensp; Last Modified: {{ proposal.modified | date }}
{% endblock %}
{% block page-tools-class %}
    {% if not owner and not admin %}hidden{% endif %}
{% endblock %}

{% block extra_css %}
    <link href="{% static 'proposals/proposals.min.css' %}" rel="stylesheet"/>
    <link href="{% static 'proposals/reviews.min.css' %}" rel="stylesheet"/>
{% endblock %}

{% block page-tools %}
    {% if owner %}
        {% if proposal.state == proposal.STATES.draft %}
            {% if validation.pages %}
                <a href='#0' title='Incomplete Proposal' disabled class="pull-right">
                    <i class="bi-exclamation-triangle icon-md icon-fw"></i><br/>
                    <span class="tool-label">Submit</span>
                </a>
            {% else %}
                <a href='#0' data-modal-url='{% url "submit-proposal" pk=object.pk %}' class="pull-right">
                    <i class="bi-arrow-right-circle icon-md icon-fw text-success"></i><br/>
                    <span class="tool-label">Submit</span>
                </a>
            {% endif %}
            <a href='{% url "edit-proposal" pk=object.pk %}' class="pull-right">
                <i class="bi-pencil icon-md icon-fw "></i><br/>
                <span class="tool-label">Edit</span>
            </a>
            <a href='#0' data-modal-url='{% url "delete-proposal" pk=object.pk %}' class="pull-right">
                <i class="bi-trash icon-md text-danger icon-fw"></i><br/>
                <span class="tool-label">Delete</span>
            </a>
        {% endif %}
        <a href='#0' data-modal-url='{% url "clone-proposal" pk=object.pk %}' class="pull-right">
            <i class="bi-copy icon-md icon-fw"></i><br/>
            <span class="tool-label">Clone</span>
        </a>
        <a href='#0' data-modal-url='{% url "proposal-attachments" pk=object.pk %}' class="pull-right">
            <i class="bi-paperclip icon-md icon-fw"></i>
            {% if proposal.attachments.exist %}
                <span class="badge bg-primary text-condensed">{{ proposal.attachments.count }}</span>
            {% endif %}<br/>
            <span class="tool-label">Attachments</span>
        </a>
        {% if proposal.clarifications.exists %}
            <a href='#proposal-clarifications' class="pull-right"
               data-bs-toggle="collapse" title="Clarifications"
               aria-expanded="false" aria-controls="proposal-clarifications">
                <i class="bi-chat-right-text icon-md icon-fw"></i><span
                    class="badge rounded-circle bg-warning text-condensed">{{ proposal.clarifications.count }}</span><br/>
                <span class="tool-label">Clarifications</span>
            </a>
        {% endif %}
    {% endif %}
    {% for submission in proposal.submissions.all %}
        <a href='{{ submission.get_absolute_url }}'
           title="{{ submission.track.acronym }} Submission">
            <span class="icon-stack">
                <i class="bi-journal icon-md"></i>
                <small class="text-condensed">{{ submission.track.acronym }}</small>
            </span><br/>
            <span class="tool-label">{{ submission.code }}</span>
        </a>
    {% endfor %}
{% endblock %}


{% block page-status-style %}callout {% folio_status proposal.state draft=proposal.STATES.draft success=proposal.STATES.submitted %}{% endblock %}

{% block page-status-bar %}
    <h3 class="my-0"><span class="badge bg-info text-condensed">{{ proposal.get_state_display }}</span>
    </h3>
    <div>
        <small class="text-wide text-body-secondary">Spokesperson:</small><br/>{{ proposal.spokesperson|default:"&hellip;" }}<br/>
        <small class="text-wide text-body-secondary">Delegate:</small><br/>{{ proposal.get_delegate|default:"&hellip;" }}
    </div>
    <div>
        <small class="text-wide text-body-secondary">Address:</small><br/>
        {% if proposal.spokesperson.address %}
            {% with proposal.spokesperson.address as address %}
                <p class="text-condensed">
                    {{ address.address_1 }},<br/> {{ address.address_2 }}, {{ address.city }},<br/>
                    {{ address.region }}, {{ address.postal_code }}, {{ address.country }}
                </p>
            {% endwith %}
        {% else %}
            &hellip;
        {% endif %}
    </div>
    <div>
        <small class="text-wide text-body-secondary">Hazards:</small><br/>
        <div class="pictogram-box">
            {% for hz in  proposal.details.sample_hazards|fetch_hazards %}
                {% with 'samples/pictograms/'|add:hz.code|add:'.svg' as pictogram_svg %}
                    <img src="{% static pictogram_svg %}" title="{{ hz.name }}">
                {% endwith %}
            {% empty %}
                &emsp;&hellip;&emsp;
            {% endfor %}
        </div>
    </div>
{% endblock %}

{% block page-content %}
    {% if proposal.state == proposal.STATES.draft and validation.pages %}
        <div class="alert alert-warning-subtle">
        <div class="row">
            <i class="bi-exclamation-triangle icon-4 col-xs-1 text-warning"></i>
            <div class="col-xs-11">Please edit and fix the following issues before submitting:<br/>
                <ul class="list-unstyled">
                    {% for page in object.form_type.pages %}
                        {% with validation|page_errors:forloop.counter0 as errors %}{% if errors %}
                            <li><strong>{{ page.name }}</strong> <i class="bi-arrow-right"></i>
                                {% for f, e in errors.items %}
                                    {{ e|safe }}{% if not forloop.last %} &middot;
                                    {% endif %}{% endfor %}</li>
                        {% endif %}{% endwith %}
                    {% endfor %}
                </ul>
            </div>
        </div>
        </div>
    {% endif %}

    {% if proposal.clarifications.count %}
        <div class="row collapse {% if proposal.clarifications.pending.count %}in{% endif %}"
             id="proposal-clarifications">
            <div class="col-xs-12">
                <div class="p-3 bg-notes-warning">
                    <h4 class="my-0">Clarification Requests</h4>
                    <hr class="hr-xs"/>
                    {% include "proposals/clarifications.html" with response_url_name='proposal-clarification-response' %}
                </div>
            </div>
        </div>
    {% endif %}
    <div class="p-5">
        {% include "proposals/proposal-content.html" %}
    </div>
{% endblock %}


