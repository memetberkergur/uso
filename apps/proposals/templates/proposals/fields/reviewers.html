{% load dynforms %}
{% load proposal_tags %}

{% update_review_data %}
<div class="controls {{ repeatable }}" id="{{ field.name }}__controls" data-repeat-name="{{ repeat_name }}__controls">
    <div class="row">
        <div class="field-group-item col">
            <select name="{{ field.name }}__type" id="{{ field.name }}__type" aria-label="{{ field.label }} Type"
                    data-repeat-name="{{ repeat_name }}__type"
                    class="form-select " data-placeholder="Select Review Type">
                <option value="" data-review-role=""></option>
                {% for rev_type in review_types %}
                <option value={{ rev_type.pk }} data-review-role="{{  rev_type.role }}">{{ rev_type }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="field-group-item col">
            <div class="input-group">
                <select name="{{ field.name }}__reviewer" id="{{ field.name }}__reviewer"
                        data-repeat-name="{{ repeat_name }}__reviewer"
                        aria-label="{{ field.label }} Reviewer"
                        class="form-select"  data-placeholder="Select Reviewer/Role" data-selected-username="">
                </select>
                <button type="button" class="btn btn-danger remove-repeat" title="Delete entry">
                    <i class="bi-x-lg "></i>
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    function updateReviewerField(element) {
        const $reviewerField = element.closest('.controls').find('select[name$="__reviewer"]');
        const role = element.find(':selected').attr('data-review-role');
        $reviewerField.load('{% url "reviewer-options" %}?role=' + role);
    }
    $(document).on('change', 'select[name$="__type"]', function () {
        updateReviewerField($(this));
    });
    $(document).on('change', 'select[name$="__reviewer"]', function () {
        $(this).attr("data-selected-username", $(this).val());
    });
    // execute at the end
    $(function () {
        window.setTimeout(function () {
            updateReviewerField($('select[name$="__type"]'));
        }, 0);
    });

</script>