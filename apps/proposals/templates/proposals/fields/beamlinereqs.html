{% load dynforms %}
{% load jsonify %}
{% load proposal_tags %}
{% get_options data=data as options %}
<div class="controls {{ repeatable }}" id="{{ field.name }}-controls--{{ repeat_index }}"
     data-field-name="{{ field.name }}" data-repeat-index="{{ repeat_index }}">
    <div class="row">
        <div class="field-group-item col-7">
            <select name="{{ field.name }}.techniques" id="{{ field.name }}-techniques--{{ repeat_index }}"
                    data-repeat-name="{{ field.name }}"
                    multiple class="form-select-multiple {{ required }}" data-placeholder="Select techniques">
                {% for technique in options.techniques %}
                    <option value="{{ technique.id }}" data-related="{{ technique.facilities|jsonify }}"
                            class="option-technique-{{ technique.id }}"
                            {% if technique.selected %}selected="selected" {% endif %}>{{ technique.name }}
                    </option>
                {% endfor %}
            </select>
            <label for="{{ field.name }}-techniques--{{ repeat_index }}" class="sub-label">
                Techniques<span class="text-danger">∗</span>
            </label>
        </div>
        <div class="field-group-item col-3">
            <select name="{{ field.name }}.facility" id="{{ field.name }}-facility--{{ repeat_index }}"
                    class="form-select {{ required }}" data-placeholder="Select facility">
                <option value=""></option>
                {% for facility in options.facilities %}
                    <option value="{{ facility.id }}" data-related="{{ facility.techniques|jsonify }}"
                            class="option-facility-{{ facility.id }}"
                            {% if facility.selected %}selected="selected" {% endif %}
                    >{{ facility.name }}
                    </option>
                {% endfor %}
            </select>
            <label for="{{ field.name }}-facility--{{ repeat_index }}" class="sub-label">
                Facility<span class="text-danger">∗</span>
            </label>
        </div>
        <div class="field-group-item col-2">
            {% if "repeat" in field.options %}
                <div class="input-group">
                    <input id="{{ field.name }}-shifts" name="{{ field.name }}.shifts" class="form-control" min="0"
                           value="{{ data.shifts }}" aria-label="{{ field.label }} shifts">
                    <button type="button"
                            title="Delete facility, techniques, justification and procedure from {{ field.label }}"
                            class="btn btn-danger remove-repeat">
                        <i class="bi-dash-lg "></i>
                    </button>

                </div>
            {% else %}
                <input id="{{ field.name }}-shifts--{{ repeat_index }}" name="{{ field.name }}.shifts"
                       class="form-control" type="number"
                       value="{{ data.shifts }}" placeholder="No. of shifts">
            {% endif %}
            <label for="{{ field.name }}-shifts--{{ repeat_index }}" class="sub-label">Shifts</label>
        </div>
    </div>
    <div class="row">
        <div class="field-group-item col-12 beamline-info repeat-html-clear"></div>
    </div>
    <div class="row">
        <div class="field-group-item col-12">
            <textarea cols="40" name="{{ field.name }}.procedure" id="{{ field.name }}-procedure--{{ repeat_index }}"
                      rows="3" class="textarea form-control {{ required }}">{{ data.procedure }}</textarea>
            <label for="{{ field.name }}-procedure--{{ repeat_index }}" class="sub-label">Experimental Procedure<span
                    class="text-danger">∗</span>
            </label>
        </div>
    </div>

    {% if "justification" in field.options %}
        <div class="row">
            <div class="field-group-item col-12">
                <textarea cols="40" name="{{ field.name }}.justification" id="{{ field.name }}-justification--{{ repeat_index }}"
                          rows="5" class="textarea form-control {{ required }}">{{ data.justification }}</textarea>
                <label for="{{ field.name }}-justification--{{ repeat_index }}" class="sub-label ">Justification of Suitability<span
                        class="text-danger">∗</span>
                </label>
            </div>
        </div>
    {% endif %}
</div>
<hr/>
<script>
    function updateMatrix(techField, facField, data) {
        const $techniquesField = $(techField);
        const $facilitiesField = $(facField);

        $.each(data.techniques, function (i, row) {
            let option = $techniquesField.find(`option[value='${row[0]}']`);
            option.data('related', row[3]);
        });
        $.each(data.facilities, function (i, row) {
            let option = $facilitiesField.find(`option[value='${row[0]}']`);
            option.data('related', row[3]);
        });
    }

    function updateRelated(target, related) {
        const $field = $(target);
        const selected = new Set(related);
        $field.find('option').removeAttr('disabled');
        console.log(target, related)
        if (selected.size) {
            $field.find('option').each(function () {
                let related = new Set($(this).data('related') || []);
                if (related.size === 0) {
                    $(this).removeAttr('disabled');
                } else if (selected.intersection(related).size === 0) {
                    $(this).attr('disabled', 'disabled');
                }
            });
        }
    }

    $(document).ready(function () {
        new SlimSelect({
            select: "#{{ field.name }}-techniques--{{ repeat_index }}",
            placeholder: "Select techniques",
            showSearch: true,
            searchPlaceholder: "Search techniques",
            allowDeselect: true,
        });

        $(document).on('cycle-changed', function (event, data) {
            localStorage.setItem('techniquesMatrix', JSON.stringify(data));
            updateMatrix(
                '#{{field.name}}-techniques--{{repeat_index}}',
                '#{{field.name}}-facility--{{repeat_index}}',
                data
            );
        });
        $(document).on('change', '[name^="{{field.name}}.techniques"]', function(){
            const selected =  $(this).val() || [];
            const $target = $(this).closest('.controls').find('[name^="{{field.name}}.facility"]');
            updateRelated($target, selected.map(Number));
        });

        $(document).on('change', '[name^="{{field.name}}.facility"]', function(){
            const facility = $(this).val() || '';
            const selected =  facility ? [facility] : [];
            const $target = $(this).closest('.controls').find('[name^="{{field.name}}.techniques"]');
            updateRelated($target, selected.map(Number));

            // beamline information
            if (facility) {
                const infoUrl = "{% url 'beamline-info' %}";
                const $facilityInfo = $(this).closest('.controls').find('div.beamline-info');
                $facilityInfo.load(infoUrl + facility);
            } else {
                $(this).closest('.controls').find('div.beamline-info').empty();
            }
        });

        $('#{{field.name}}-facility--{{repeat_index}}').trigger('change');
    });

</script>
