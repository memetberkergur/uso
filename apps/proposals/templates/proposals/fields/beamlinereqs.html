{% load dynforms %}
{% load jsonify %}
{% load proposal_tags %}
{% get_options data=data as options %}
<div class="controls {{ repeatable }}" id="{{ field.name }}-controls{{ repeat_index }}"
     data-field-name="{{ field.name }}" data-repeat-index="{{ repeat_index }}">
    <div class="row">
        <div class="field-group-item col-7">
            <select name="{{ field.name }}.techniques" id="{{ field.name }}-techniques{{ repeat_index }}"
                    multiple="multiple"
                    class="form-select selectize {{ required }}" data-placeholder="Select techniques">
                {% for tech_id, tech, selected, tech_facs in options.techniques %}
                    <option value="{{ tech_id }}" data-related="{{ tech_facs|jsonify }}"
                            class="option-technique-{{ tech_id }}"
                            {% if selected %}selected="selected" {% endif %}>{{ tech }}
                    </option>
                {% endfor %}
            </select>
            <label for="{{ field.name }}-techniques{{ repeat_index }}" class="sub-label">
                Techniques<span class="text-danger">∗</span>
            </label>
        </div>
        <div class="field-group-item col-3">
            <select name="{{ field.name }}.facility" id="{{ field.name }}-facility{{ repeat_index }}"
                    class="form-select {{ required }}" data-placeholder="Select facility">
                <option value=""></option>
                {% for bl_id, bl, selected, bl_techs in options.facilities %}
                    <option value="{{ bl_id }}" data-related="{{ bl_techs|jsonify }}"
                            class="option-facility-{{ bl_id }}"
                            {% if selected %}selected="selected" {% endif %}
                    >{{ bl }}
                    </option>
                {% endfor %}
            </select>
            <label for="{{ field.name }}-facility{{ repeat_index }}" class="sub-label">
                Facility<span class="text-danger">∗</span>
            </label>
        </div>
        <div class="field-group-item col-2">
            {% if "repeat" in field.options %}
                <div class="input-group">
                    <input id="{{ field.name }}-shifts" name="{{ field.name }}.shifts" class="form-control" min="0"
                           value="{{ data.shifts }}" aria-label="{{ field.label }} shifts">
                    <button type="button"
                            title="Delete facility, techniques, justification and procedure from {{ field.label }}"
                            class="btn btn-danger remove-repeat">
                        <i class="bi-dash-lg "></i>
                    </button>

                </div>
            {% else %}
                <input id="{{ field.name }}-shifts{{ repeat_index }}" name="{{ field.name }}.shifts"
                       class="form-control" type="number"
                       value="{{ data.shifts }}" placeholder="No. of shifts">
            {% endif %}
            <label for="{{ field.name }}-shifts{{ repeat_index }}" class="sub-label">Shifts
                <i class="df-info bi-info-circle text-primary" data-bs-toggle="popover" data-placement="bottom"
                   data-trigger="hover"
                   data-content="Specify the number of shifts you are requesting for the first cycle."></i>
            </label>
        </div>
    </div>
    <div class="row">
        <div class="field-group-item col-12 beamline-info"></div>
    </div>
    <div class="row">
        <div class="field-group-item col-12">
            <textarea cols="40" name="{{ field.name }}.procedure" id="{{ field.name }}-procedure"
                      rows="3" class="textarea form-control {{ required }}">{{ data.procedure }}</textarea>
            <label for="{{ field.name }}-procedure" class="sub-label">Experimental Procedure<span
                    class="text-danger">∗</span>
                <i class="df-info bi-info-circle text-primary" data-bs-toggle="popover" data-placement="bottom"
                   data-trigger="hover"
                   data-content="Describe the experimental procedure for this beamline."></i>
            </label>
        </div>
    </div>

    {% if "justification" in field.options %}
        <div class="row">
            <div class="field-group-item col-12">
                <textarea cols="40" name="{{ field.name }}.justification" id="{{ field.name }}-justification"
                          rows="5" class="textarea form-control {{ required }}">{{ data.justification }}</textarea>
                <label for="{{ field.name }}-justification" class="sub-label ">Justification of Suitability<span
                        class="text-danger">∗</span>
                    <i class="df-info bi-info-circle text-primary" data-bs-toggle="popover" data-placement="bottom"
                       data-trigger="hover"
                       data-content="Please justify the suitability of this beamline and the corresponding number of shifts requested."></i>
                </label>
            </div>
        </div>
    {% endif %}
    {% if "tags" in field.options %}
        <div class="row" id="{{ field.name }}-tags-selector">
        </div>
    {% endif %}
</div>
<hr/>
<script>
    $(document).ready(function () {

        $('[name="{{ field.name }}.techniques"]').selectize({
            plugins: ['remove_button'],
        });


        $('#{{field.name}}-techniques{{repeat_index}}, #{{field.name}}-facility{{repeat_index}}').change(function () {
            const techniquesField = $(this).closest('.controls').find('[name^="{{field.name}}.techniques"]');
            const facilitiesField = techniquesField.closest('.controls').find('[name^="{{field.name}}.facility"]');
            const cycle_field = $('#first_cycle');
            let dataUrl = "{% url 'techniques-beamlines' %}?";
            const tags_field = facilitiesField.closest('.controls').find('[name^="{{field.name}}.tags"]');
            const tags_container = facilitiesField.closest('.controls').find("#{{field.name}}-tags-selector");
            let tags_url = "{% url 'facility-tags' %}";
            if (cycle_field.val()) {
                dataUrl += "&cycle=" + cycle_field.val();
            }
            $.get(dataUrl, function (data) {
                $.each(data.techniques, function (i, row) {
                    let option = techniquesField.find("[value='" + row[0] + "']");
                    option.data('related', row[3]);
                });
                $.each(data.facilities, function (i, row) {
                    let option = facilitiesField.find("[value='" + row[0] + "']");
                    option.data('related', row[3]);
                });
            });
            const goodTechniques = [];
            const goodFacilities = [];

            facilitiesField.find('option').removeAttr('disabled');
            techniquesField.find('option').removeAttr('disabled');
            if (techniquesField.val()) {
                const sel_techs = [];
                $.each(techniquesField.val(), function (i, val) {
                    sel_techs.push('option[value=' + val + ']');
                });
                techniquesField.find(sel_techs.join()).each(function () {
                    $.each($(this).data('related'), function (i, val) {
                        goodFacilities.push('[value=' + val + ']');
                    });
                });

                facilitiesField.find('option').not(goodFacilities.join()).attr('disabled', 'disabled');
            }
            if (facilitiesField.val()) {

                $.each(facilitiesField.find('option[value=' + facilitiesField.val() + ']').data('related'), function (i, val) {
                    goodTechniques.push('[value=' + val + ']');
                });
                techniquesField.find('option').not(goodTechniques.join()).attr('disabled', 'disabled');

                // tags field
                const tags = [];
                const repeat_index = facilitiesField.closest('.controls').attr('data-repeat-index');
                tags_url += facilitiesField.val() + '/{{field.name}}.tags__' + repeat_index + '/?';
                tags_field.find('option').filter(function () {
                    return !!this.value;
                }).each(function () {
                    tags.push($(this).attr('value'));
                });
                if (tags) {
                    tags_url += '&tags=' + "{{data.tags|join:','}}";
                }
                tags_container.load(tags_url);


            } else {
                tags_container.empty();
            }
            // beamline information
            const bl_url = "{% url 'beamline-info' %}";
            const fac_info = facilitiesField.closest('.controls').find('div.beamline-info');
            const fac_val = facilitiesField.val() || '';
            fac_info.load(bl_url + fac_val);

        });

        $('#first_cycle').change(function () {
            $('#{{field.name}}-facility{{repeat_index}}').trigger('change');
        });

        $('#{{field.name}}-facility{{repeat_index}}').trigger('change');
    });

</script>
