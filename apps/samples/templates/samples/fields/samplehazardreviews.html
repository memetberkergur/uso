{% load dynforms %}
{% load samples_tags %}
{% load project_tags %}
{% load jsonify %}
{% get_material_samples data=data material=reference as samples %}
<div class="controls " id="{{ field.name }}-controls" data-field-name="{{ field.name }}">
    <div class="sample-list">
        <ul id="{{ field.name }}-list" class="list-group list-group-flush">
            {% for sample, quantity, hazard_ids, sample_hazards, review_hazards, rejected, permissions in samples %}
                {% get_precautions hazards=review_hazards as precautions %}
                <li id="{{ field.name }}-{{ sample.pk }}-hazards-container"
                     data-saved-hazards="{{ hazard_ids|join:',' }}"
                     class="p-5 sample-row list-group-item {% if rejected %}rejected-sample{%  endif %} {% if not sample.is_editable %}reviewed-sample{% else %}pending-sample{% endif %}">
                    <div class="row">
                        <div class="col-xs-12">
						    <span class="pull-right text-right">
							{% show_pictograms sample_hazards sample.hazard_types size=28 %}
						    </span>
                            <p class="lead text-condensed"><strong>{{ sample.name }}</strong></p>
                            Quantity: <em class="text-muted">{{ quantity }}</em>&emsp;
                            Type: <em class="text-muted">{{ sample.get_kind_display }}</em>&emsp;
                            State: <em class="text-muted">{{ sample.get_state_display }}</em>&emsp;
                            Source: <em class="text-muted">{{ sample.source|default:"N/C" }}</em>&emsp;
                            {% if sample.description or sample.source or sample.extra %}
                                <hr class="hr-xs"/>
                                <em>{% if sample.description %}{{ sample.description|default:"" }}</em>{% endif %}
                            {% endif %}
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-xs-12" id="{{ field.name }}-{{ sample.pk }}-hazards">
                            <hr class="hr-xs"/>
                            <span class="pull-left text-right" style="margin-right: 2em; line-height: 24px;">
                            {% if sample.is_editable %}
                                {% if rejected %}
                                    <text class="text-danger pull-left text-condensed">&nbsp;REJECTED&nbsp;</text>
                                {% else %}
                                    <text class="text-info pull-left text-condensed">&nbsp;IN PROGRESS&nbsp;</text>
                                {% endif %}
                                {% show_pictograms review_hazards size=24 %}
                            {% else %}
                                <text class="text-info pull-left text-condensed">&nbsp;REVIEWED&nbsp;</text>
                            {% endif %}
                                <text class="text-info text-condensed" id="{{ field.name }}-{{ sample.pk }}-msgs"></text>
						    </span>

                            {% if sample.is_editable %}
                                <a title="Toggle Reject" href='#0' class="reject-sample-command command-icon pull-right">
                                    <i class="icon-fw icon-md"></i>
                                </a>
                                <a title="Hazards" href='#0' class="command-icon pull-right {% if hazard_ids %}highlighted{% endif %}"
                                   id="hazard-command-{{ sample.pk }}"
                                   data-modal-url="{% url 'sample-hazards'  pk=sample.pk field_name=field.name %}?hazards={{ hazard_ids}}"
                                >
                                    <i class="bi-activity icon-md icon-fw"></i>
                                </a>
                                <a title="Permissions" href='#0' class="command-icon  pull-right {% if permissions %}highlighted{% endif %}"
                                      id="permission-command-{{ sample.pk }}"
                                   data-modal-url="{% url 'sample-permissions'  pk=sample.pk field_name=field.name %}">
                                    <i class="bi-key icon-md icon-fw"></i>
                                </a>
                            {% else %}
                                <span title="Sample Locked! Already Reviewed." class="command-icon  pull-right">
                                    <i class="bi-lock icon-md icon-fw text-muted"></i>
                                </span>
                            {% endif %}
                            {% if precautions %}
                                <a title="Precautions" class="command-icon pull-right {% if precautions.count %}highlighted{% endif %}" role="button" data-bs-toggle="collapse"
                                   aria-expanded="false" aria-controls="hazard-precautions-{{ sample.pk }}"
                                   href='#hazard-precautions-{{ sample.pk }}'>
                                    <i class="bi-list-ol icon-md icon-fw"></i>
                                </a>
                            {% endif %}
                            <input type="hidden" class="pk-field" name="{{ field.name }}.sample.{{ sample.pk }}" value="{{ sample.pk }}">
                            <input type="hidden" class="hazards-field" name="{{ field.name }}.hazards.{{ sample.pk }}"
                                   data-saved-hazards='{{ hazard_ids|jsonify}}'
                                   value='{{ hazard_ids|jsonify}}'
                                   id="saved-hazards-{{ sample.pk }}"
                            >
                            <input id="permissions-{{ sample.pk }}" type="hidden" class="permissions-field" name="{{ field.name }}.permissions.{{ sample.pk }}"  value='{{ permissions|jsonify }}'>
                            <input id="rejected-{{ sample.pk }}" type="hidden" class="rejection-field" name="{{ field.name }}.rejected.{{ sample.pk }}" {% if rejected %}value=1{% endif %}>
                            <input id="keywords-{{ sample.pk }}" type="hidden" class="keywords-field" name="{{ field.name }}.keywords.{{ sample.pk }}." value="">
                        </div>
                    </div>

                    <div id="hazard-changes-{{ sample.pk }}" class="p-3 mb-3 bg-warning d-none changes-notes">
                        <i class="bi-floppy icon-fw" title="Changes have not been saved"></i>&ensp;
                        <span class="added"></span>&ensp;
                        <span class="removed"></span>
                    </div>

                    <div class="row">

                        <!-- Precautions Section -->
                        <div class="col-xs-12 collapse" id="hazard-precautions-{{ sample.pk }}">
                            <table class="table table-hover" style="font-size: 85%;">
                                <tr>
                                    <th colspan="2">Precaution Statement</th>
                                    <th>Keyword</th>
                                </tr>
                                {% for p in precautions %}
                                    <tr>
                                        <td class="text-muted">{{ p.code }}</td>
                                        <td>{% precaution_text p %}</td>
                                        <td>
                                            {% if "{}" in p.text %}
                                                <input width="auto" placeholder="keyword" type="text"
                                                       name="{{ field.name }}.keywords.{{ sample.pk }}.{{ p.code }}"
                                                       value="{% precaution_keyword p %}"
                                                >
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endfor %}
                            </table>
                        </div>
                    </div>
                </li>
            {% empty %}
                <div class="empty">
                    <i class="bi-exclamation-triangle text-warning icon-md"></i><br/>
                    This project will not use any samples.
                </div>
            {% endfor %}
        </ul>
    </div>
</div>

<script type="text/javascript">
    $(document).ready(function () {
        $(document).on('click', '.reject-sample-command', function () {
            // Toggle the rejection state of the sample
            const $rejectInput = $(this).siblings("input.rejection-field");
            const container = $rejectInput.closest(".sample-row");
            const val = $rejectInput.val();

            if (val) {
                $rejectInput.val("");
                container.removeClass("rejected-sample");
            } else {
                $rejectInput.val(1);
                $rejectInput.change();
                container.addClass("rejected-sample");
            }
        });
    });
</script>
