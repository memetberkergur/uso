{% load dynforms %}
{% load static %}
{% load samples_tags %}
{% load project_tags %}
{% load jsonify %}


<div class="sample-row py-5 list-group-item border-secondary {% if rejected %}rejected-sample {% endif %}{% if not sample.is_editable %}reviewed-sample{% else %}pending-sample{% endif %}"
     id="{{ field.name }}-{{ sample.pk }}-hazards-container"
>
    <div class="d-flex flex-row justify-content-between align-items-center">
        <strong class="fs-5">{{ sample.name }}</strong>
        {% show_pictograms hazards types=sample.hazard_types %}
    </div>

    <span>{{ sample.description|default:""|safe }}</span>

    <div class="sample-properties">
        <div class="sample-property">
            <div class="text-body-secondary small">Quantity:</div>
            <div>{{ quantity|default:"&hellip;" }}</div>
        </div>
        <div class="sample-property">
            <div class="text-body-secondary small">Type:</div>
            <div>{{ sample.get_kind_display }}</div>
        </div>
        <div class="sample-property">
            <div class="text-body-secondary small">State:</div>
            <div>{{ sample.get_state_display }}</div>
        </div>
        <div class="sample-property">
            <div class="text-body-secondary small">Source:</div>
            <div>{{ sample.source|default:"N/C" }}</div>
        </div>
    </div>


    <div class="sample-review-commands">
        {% if not sample.is_editable %}
            <div class="text-primary-emphasis">Reviewed</div>
        {% elif rejected %}
            <div class="text-danger-emphasis">Rejected</div>
        {% else %}
            <div class="text-info-emphasis">In Progress</div>
        {% endif %}

        <div class="sample-review-toolbar">
            {% if sample.is_editable %}
                <a title="Toggle Reject"
                   href="#0"
                   data-bs-toggle="tooltip"
                   class="command-icon reject-sample-command"
                >
                    <i class="bi"></i>
                </a>
                <a title="Review Hazards" href="#0"
                   data-bs-toggle="tooltip"
                   class="command-icon {% if hazards %}highlighted{% endif %}"
                   id="hazard-command-{{ sample.pk }}"
                   data-modal-url="{% url 'sample-hazards'  pk=sample.pk field_name=field.name %}"
                >
                    <i class="bi-exclamation-diamond icon-fw"></i>
                </a>
                <a title="Edit Permissions" href="#0"
                   data-bs-toggle="tooltip"
                   class="command-icon {% if permissions %}highlighted{% endif %}"
                   id="permission-command-{{ sample.pk }}"
                   data-modal-url="{% url 'sample-permissions' pk=sample.pk field_name=field.name %}"
                >
                    <i class="bi-key icon-fw"></i>
                </a>
            {% else %}
                <a title="Sample Locked! Already Reviewed" data-bs-toggle="tooltip">
                    <i class="bi-lock icon-fw text-body-secondary"></i>
                </a>
            {% endif %}
            {% if precautions %}
                <a title="Edit Precautions"
                   class="command-icon {% if precautions.count %}highlighted{% endif %}"
                   data-bs-toggle="collapse"
                   role="button"
                   aria-expanded="false"
                   aria-controls="hazard-precautions-{{ sample.pk }}"
                   href="#hazard-precautions-{{ sample.pk }}"
                >
                    <i class="bi-list-ol icon-fw"></i>
                </a>
            {% endif %}
            <input type="hidden" class="pk-field"
                   name="{{ field.name }}__{{ sample.pk }}__sample"
                   value="{{ sample.pk }}"
            >
            <input type="hidden" class="hazards-field"
                   name="{{ field.name }}__{{ sample.pk }}__hazards"
                   data-saved-hazards="{{ hazards|query_ids|jsonify }}"
                   value="{{ hazards|query_ids|jsonify }}"
                   id="saved-hazards-{{ sample.pk }}"
            >
            <textarea id="permissions-{{ sample.pk }}" class="d-none"
                      class="permissions-field" aria-label="Permissions"
                      name="{{ field.name }}__{{ sample.pk }}__permissions"
            >{{ permissions|jsonify }}</textarea>
            <input id="rejected-{{ sample.pk }}" type="hidden"
                   class="rejection-field"
                   name="{{ field.name }}__{{ sample.pk }}__rejected"
                   {% if rejected %}value="1"{% endif %}
            >
            {% get_precaution_keywords as keywords %}
            <input id="keywords-{{ sample.pk }}"
                   aria-label="Keywords"
                   type="hidden"
                   class="keywords-field" data-keywords-field="keyword-{{ sample.pk }}"
                   name="{{ field.name }}__{{ sample.pk }}__keywords"
                   value='{{ keywords|jsonify }}'
            >
        </div>
    </div>

    <div id="hazard-changes-{{ sample.pk }}" class="alert alert-warning d-none changes-notes">
        <i class="bi-floppy icon-fw" title="Changes have not been saved"></i>&ensp;
        <span class="added"></span>&ensp;
        <span class="removed"></span>
    </div>


    <div class="collapse" id="hazard-precautions-{{ sample.pk }}">
        <table class="table table-sm" style="font-size: 85%;">
            <tr>
                <th colspan="2">Precaution Statement</th>
                <th>Keyword</th>
            </tr>
            {% for p in precautions %}
                <tr>
                    <td class="text-body-secondary">{{ p.code }}</td>
                    <td>{% precaution_text p %}</td>
                    <td>
                        {% if "{}" in p.text %}
                            <input style="width:auto;" placeholder="keyword" type="text"
                                   id="keyword-{{ sample.pk }}-{{ p.code }}"
                                   class="keyword-{{ sample.pk }}"
                                   aria-label="Precaution Keywords"
                                   data-keyword-code="{{ p.code }}"
                                   value="{% precaution_keyword p %}">
                        {% endif %}
                    </td>
                </tr>
            {% endfor %}
        </table>
    </div>
</div>