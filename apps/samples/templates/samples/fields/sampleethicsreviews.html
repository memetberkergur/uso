{% load dynforms %}
{% load samples_tags %}
{% load project_tags %}

{% get_ethics_samples data=data as samples %}
<div class="controls" id="{{ field.name }}-controls" data-field-name="{{ field.name }}">
    <div class="sample-list">
        <div id="{{ field.name }}-list" class="list-group list-group-flush">
            {% for sample, quantity, decision, expiry in samples %}
                <div class="sample-row py-4 list-group-item {% if rejected %}rejected-sample {% endif %}{% if not sample.is_editable %}reviewed-sample{% else %}pending-sample{% endif %}"
                     id="{{ field.name }}-{{ sample.pk }}-ethics-container">
                    <div class="d-flex flex-row justify-content-start align-items-start gap-3">
                        <div>
                            <div class="lead">{{ sample.name }}</div>
                            <em>{{ sample.description|default:""|safe }}</em>
                        </div>
                        <i class="bi-{% if sample.is_editable %}unlock{% else %}lock{% endif %} icon-md icon-fw"></i>
                    </div>

                    <div class="sample-properties">
                        <div class="sample-property">
                            <div class="text-body-secondary small">Quantity:</div>
                            <div>{{ quantity|default:"&hellip;" }}</div>
                        </div>
                        <div class="sample-property">
                            <div class="text-body-secondary small">Type:</div>
                            <div>{{ sample.get_kind_display }}</div>
                        </div>
                        <div class="sample-property">
                            <div class="text-body-secondary small">State:</div>
                            <div>{{ sample.get_state_display }}</div>
                        </div>
                        <div class="sample-property">
                            <div class="text-body-secondary small">Source:</div>
                            <div>{{ sample.source|default:"N/C" }}</div>
                        </div>
                    </div>

                    <div class="row sample-group no-space" id="{{ field.name }}-{{ sample.pk }}-review">
                        <div class="field-group-item col-sm-6">
                            <label class="form-label" for="{{ field.name }}-decision-{{ sample.pk }}">Decision</label>
                            <select class="form-select" name="{{ field.name }}__{{ sample.pk }}__decision"
                                    id="{{ field.name }}-decision-{{ sample.pk }}">
                                <option></option>
                                <option value="ethics" {% if decision == "ethics" %}selected{% endif %}>Valid Ethics
                                    Certificate
                                </option>
                                <option value="protocol" {% if decision == "protocol" %}selected{% endif %}>Valid AUP
                                    Certificate
                                </option>
                                <option value="exempt" {% if decision == "exempt" %}selected{% endif %}>Exempt</option>
                                <option value="rejected" {% if decision == "rejected" %}selected{% endif %}>Reject
                                </option>
                            </select>
                        </div>
                        <div class="expiry-field field-group-item col-sm-6"
                             id="{{ field.name }}-expiry-{{ sample.pk }}-input">
                            <label class="form-label" for="{{ field.name }}-expiry-{{ sample.pk }}">Expiry Date</label>
                            <input id="{{ field.name }}-expiry-{{ sample.pk }}" aria-label="Expiry Date"
                                   placeholder="Expiry date" name="{{ field.name }}__{{ sample.pk }}__expiry"
                                   class="form-control date-input"
                                   data-date-container="#{{ field.name }}-expiry-{{ sample.pk }}-input"
                                   type="text" value="{{ expiry|default:'' }}"
                                   {% if decision == "exempt" or decision == "rejected" %}disabled{% endif %}>
                        </div>
                    </div>
                    <input type="hidden" aria-label="Sample ID" name="{{ field.name }}__{{ sample.pk }}__sample"
                           value="{{ sample.pk }}">
                </div>
            {% empty %}
                <div class="empty">
                    <i class="bi-exclamation-triangle text-warning icon-md"></i><br/>
                    No samples requiring Ethics Review.
                </div>
            {% endfor %}
        </div>
    </div>
</div>

<script>
    $(document).ready(function () {
        $(document).on('change', 'input[name$="__decision"]', function () {
            const expiryTypes = ["ethics", "protocol"];
            const value = $(this).closest('input:checked').val();
            const $expiryField = $(this).closest('.sample-group').find('.expiry-field input');
            if ($.inArray(value, expiryTypes) >= 0) {
                $expiryField.prop('disabled', false);
            } else {
                $expiryField.prop('disabled', true);
            }
        });
        $('.expiry-field .date-input').datePicker({
            format: "YYYY-MM-DD",
        });
    });

</script>
