{% extends "crisp_modals/modal.html" %}
{% load samples_tags %}
{% load static %}
{% load misc %}
{% block modal_title %}Edit Sample Hazards{% endblock %}
{% block modal_styles %}hazards-editor modal-lg{% endblock %}
{% block modal_body %}
    <form id="hazards-form">
        <div id="hazard-editor" class="d-flex flex-column justify-content-start align-items-stretch w-100">

            <ul class="nav nav-tabs pt-3">
                {% for group in categories %}
                    <li class="nav-item">
                        <a href="#hazard-tab{{ forloop.counter }}"
                           class="nav-link position-relative {% if forloop.first %}active{% endif %}"
                           {% if forloop.first %}aria-current="page"{% endif %}
                           role="tab" data-bs-toggle="tab">
                            <img width="32" height="32" src="{{ group.image }}" title="{{ group.name }}"
                                 alt="{{ group.name }}"
                            />
                            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-primary category-count"></span>
                        </a>
                    </li>
                {% endfor %}
            </ul>

            <div class="tab-content" style="max-height: 300px; height: 300px; overflow-y: auto;">
                {% for group in categories %}
                    <div class="tab-pane {% if forloop.first %}active{% endif %} p-3" id="hazard-tab{{ forloop.counter }}">
                        <h4><strong>{{ group.name }}</strong>&mdash;{{ group.description }}</h4>
                        <hr class="hr-xs"/>
                        <ul class="list-group list-group-flush">
                            {% with forloop.counter as group_number %}
                            {% for hz in group.hazards %}
                                <li class="list-group-item">
                                    <div class="form-check">
                                            <input name="hazard_list" class="form-check-input"
                                                   id="hazards-{{ group_number }}-{{ hz.pk }}"
                                                   value="{{ hz.pk }}"
                                                   {% if hz.selected %}checked="checked"{% endif %}
                                                   data-hazard-code="{{ hz.hazard.code }}"
                                                   type="checkbox"
                                                   >
                                            <label for="hazards-{{ group_number }}-{{ hz.pk }}" class="form-check-label d-flex">
                                                {{ hz.hazard.code }}&nbsp;{% if hz.signal %}
                                                <strong>{{ hz.signal.title }}:</strong>&ensp;{% endif %}
                                                {{ hz.hazard.text }}
                                                {% for pic in hz.pictograms.all %}
                                                    <img class="media-object ms-auto" alt="{{ pic.name }}"
                                                         width="24" height="24"
                                                         src="{% pictogram_url pic %}"
                                                         title="{{ pic.name }}" data-sample-hazard="{{ pic.pk }}"
                                                    />
                                                {% endfor %}
                                            </label>
                                        </div>
                                </li>
                            {% endfor %}
                            {% endwith %}
                        </ul>
                    </div>
                {% endfor %}

            </div>
        </div>
    </form>
{% endblock %}
{% block modal_footer %}
    <button class="btn btn-secondary pull-left" data-bs-dismiss="modal" type="button">Cancel</button>
    <button id="apply-decision" type="button" data-command="approve" class="btn btn-primary">Apply</button>
{% endblock %}
{% block modal_scripts %}
    <script>
        function updateHazardCounts() {
            // Update the hazard counts in the tab headers
            $("#hazard-editor .nav-tabs .nav-link").each(function () {
                let tabId = $(this).attr('href');
                let numSelected = $(`${tabId} input:checked`).length;
                $(this).find('.category-count').html(numSelected ? `${numSelected}` : "");
            });
        }

        $(document).ready(function () {
            const $form = $("#hazards-form");
            const hazards = JSON.parse($("#saved-hazards-{{ sample.pk }}").val() || "[]");  // Get saved hazards from the input field

            // Initialize the checkboxes based on saved hazards
            $form.find("input[name='hazard_list']").each(function () {
                let $input = $(this);   // current checkbox input
                let hazardId = Number($input.val());
                if (hazards.includes(hazardId)) {
                    $input.prop('checked', true);
                } else {
                    $input.prop('checked', false);
                }
            });

            updateHazardCounts();   // Initial count update
            $form.on('click', 'input', function () {
                const $input = $(this);
                // Some hazards appear on multiple tabs, so we need to ensure that when one is clicked,
                // all inputs with the same hazard code are checked or unchecked accordingly.
                $form.find(`input[data-hazard-code="${$input.data('hazard-code')}"]`).each(function () {
                    $(this).prop('checked', $input.is(':checked'));
                });
                updateHazardCounts();
            });
            $("#apply-decision").click(function () {
                // Collect selected hazards and their codes and apply them to the input fields within
                // the main form from which this modal was opened.
                const selected = new Set();
                const selectedCodes = new Set();
                const previousCodes = new Set();
                const $hazardsInput = $("#saved-hazards-{{ sample.pk }}");
                const previous = new Set($hazardsInput.data("saved-hazards"));  // initialize with previously saved values


                $form.find("input[name='hazard_list']").each(function () {
                    let $input = $(this);   // current checkbox input

                    // Get the value and code from the input if checked
                    if ($input.is(':checked')) {
                        selected.add(Number($input.val()));
                        selectedCodes.add($input.data('hazard-code'));
                    }
                    // save codes for previously selected hazards
                    if (previous.has(Number($input.val()))) {
                        previousCodes.add($input.data('hazard-code'));
                    }
                });

                const removedCodes = previousCodes.difference(selectedCodes);
                const addedCodes = selectedCodes.difference(previousCodes);
                $hazardsInput.val(JSON.stringify([...selected]));
                $hazardsInput.change();

                const $notification = $("#hazard-changes-{{ sample.pk }}");
                const $added = $notification.find(".added");
                const $removed = $notification.find(".removed");

                if ((removedCodes.size) || (addedCodes.size)) {
                    $notification.removeClass("d-none");
                    $removed.html("");
                    $added.html("");
                    if (removedCodes.size) {
                        $removed.html(`Removed: ${[...removedCodes].join(', ')}`);
                    }
                    if (addedCodes.size) {
                        $added.html(`Added: ${[...addedCodes].join(', ')}`);
                    }
                } else {
                    $notification.addClass("d-none");
                }
                if (selected.size) {
                    $("#hazard-command-{{ sample.pk }}").addClass('highlighted');
                } else {
                    $("#hazard-command-{{ sample.pk }}").removeClass('highlighted');
                }
                $("#modal").modal('hide');
            });
        });
    </script>
{% endblock %}




